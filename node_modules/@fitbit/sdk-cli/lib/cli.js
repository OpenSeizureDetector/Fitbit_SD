#!/usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const os_1 = tslib_1.__importDefault(require("os"));
const process_1 = tslib_1.__importDefault(require("process"));
const update_notifier_1 = tslib_1.__importDefault(require("update-notifier"));
const vorpal_1 = tslib_1.__importDefault(require("vorpal"));
const auth = tslib_1.__importStar(require("./auth"));
const checkForUpdate_1 = tslib_1.__importDefault(require("./checkForUpdate"));
const userProfile_1 = tslib_1.__importDefault(require("./api/userProfile"));
const AppContext_1 = tslib_1.__importDefault(require("./models/AppContext"));
const HostConnections_1 = tslib_1.__importDefault(require("./models/HostConnections"));
const LogConsumer_1 = tslib_1.__importDefault(require("./models/LogConsumer"));
const formatMessage_1 = require("./models/formatMessage");
const build_1 = tslib_1.__importDefault(require("./commands/build"));
const buildAndInstall_1 = tslib_1.__importDefault(require("./commands/buildAndInstall"));
const connect_1 = tslib_1.__importDefault(require("./commands/connect"));
const heapSnapshot_1 = tslib_1.__importDefault(require("./commands/heapSnapshot"));
const hosts_1 = tslib_1.__importDefault(require("./commands/hosts"));
const install_1 = tslib_1.__importDefault(require("./commands/install"));
const logout_1 = tslib_1.__importDefault(require("./commands/logout"));
const mockHost_1 = tslib_1.__importDefault(require("./commands/mockHost"));
const repl_1 = tslib_1.__importDefault(require("./commands/repl"));
const screenshot_1 = tslib_1.__importDefault(require("./commands/screenshot"));
const setAppPackage_1 = tslib_1.__importDefault(require("./commands/setAppPackage"));
const enableQACommands = process_1.default.env.FITBIT_QA_COMMANDS === '1';
const appContext = new AppContext_1.default();
const hostConnections = new HostConnections_1.default();
const cli = new vorpal_1.default();
cli.history('Fitbit-Command-Line-SDK');
cli.use(build_1.default);
cli.use(buildAndInstall_1.default({ hostConnections, appContext }));
cli.use(connect_1.default({ hostConnections }));
cli.use(heapSnapshot_1.default({ hostConnections }));
cli.use(install_1.default({ hostConnections, appContext }));
cli.use(screenshot_1.default({ hostConnections }));
cli.use(setAppPackage_1.default({ appContext }));
cli.use(logout_1.default);
cli.use(repl_1.default({ hostConnections }));
if (enableQACommands) {
    cli.use(hosts_1.default);
    cli.use(mockHost_1.default);
}
new LogConsumer_1.default({
    appContext,
    hostConnections,
    messageFormatter: message => formatMessage_1.formatMessage(cli, message),
});
async function main() {
    checkForUpdate_1.default(update_notifier_1.default);
    let accessToken;
    try {
        accessToken = await auth.getAccessToken();
    }
    catch (ex) {
        console.error(`Failed to read auth token from keychain: ${ex}`);
        if (os_1.default.platform() === 'darwin') {
            console.error('Try locking and then unlocking your \'login\' keychain using the Keychain Access app.');
        }
        process_1.default.exit(1);
    }
    if (accessToken === null) {
        console.log('No login information, starting login...');
        try {
            await auth.login();
        }
        catch (ex) {
            console.error(`Login failed: ${ex.message}`);
            process_1.default.exit(1);
        }
    }
    const user = await userProfile_1.default();
    console.log(`Logged in as ${user.fullName} <${user.email}>`);
    cli
        .delimiter('fitbit$')
        .show();
}
main();
//# sourceMappingURL=cli.js.map